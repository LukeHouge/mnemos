name: Check TODOs

on:
  pull_request:
    branches: [main, master, develop]

jobs:
  check-todos:
    name: Check for TODOs
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to compare branches

      - name: Find new/modified TODOs in PR
        id: find-todos
        run: |
          echo "ðŸ“‹ Checking for new or modified TODOs, FIXMEs, and XXX comments in PR..."
          echo ""

          # Get base branch (default to main)
          BASE_BRANCH="${GITHUB_BASE_REF:-main}"

          # Fetch base branch for comparison
          git fetch origin "$BASE_BRANCH:$BASE_BRANCH" || true

          # Find TODOs only in added/modified lines (not pre-existing)
          # Use git diff to find lines that were added or changed
          # Format: file:line:content (strip leading whitespace for readability)
          TODOS=$(git diff "$BASE_BRANCH...HEAD" --unified=0 | \
            awk '
              BEGIN { file = ""; line = 0 }
              /^diff --git/ { file = ""; next }
              /^\+{3} / {
                file = $2;
                gsub(/^a\//, "", file);
                gsub(/^b\//, "", file);
                next
              }
              /^@@/ {
                match($0, /\+[0-9]+/);
                if (RSTART > 0) line = substr($0, RSTART+1, RLENGTH-1);
                next
              }
              /^\+.*(TODO|FIXME|XXX|HACK|NOTE):/ {
                content = $0;
                gsub(/^\+[[:space:]]*/, "", content);
                gsub(/^[[:space:]]+/, "", content);
                if (file && line) print file ":" line ":" content;
                line++
              }
            ' || true)

          if [ -z "$TODOS" ]; then
            echo "âœ… No new or modified TODOs found in PR!"
            echo "has_todos=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Found new or modified TODOs/FIXMEs/XXX comments:"
            echo ""
            echo "$TODOS"
            echo ""
            echo "has_todos=true" >> $GITHUB_OUTPUT

            # Count by type
            TODO_COUNT=$(echo "$TODOS" | grep -c "TODO:" || echo "0")
            FIXME_COUNT=$(echo "$TODOS" | grep -c "FIXME:" || echo "0")
            XXX_COUNT=$(echo "$TODOS" | grep -c "XXX:" || echo "0")

            echo "ðŸ“Š Summary:"
            echo "  TODO: $TODO_COUNT"
            echo "  FIXME: $FIXME_COUNT"
            echo "  XXX: $XXX_COUNT"
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');

            // Get base branch
            const baseBranch = process.env.GITHUB_BASE_REF || 'main';

            // Find TODOs only in added/modified lines using git diff
            // Format: file:line:content (strip leading whitespace for readability)
            let todos = '';
            try {
              todos = execSync(
                `git diff ${baseBranch}...HEAD --unified=0 | awk '
                  BEGIN { file = ""; line = 0 }
                  /^diff --git/ { file = ""; next }
                  /^\\+\\+\\+ / { file = $2; gsub(/^a\\//, "", file); gsub(/^b\\//, "", file); next }
                  /^@@/ { match($0, /\\+[0-9]+/); if (RSTART > 0) line = substr($0, RSTART+1, RLENGTH-1); next }
                  /^\\+.*(TODO|FIXME|XXX|HACK|NOTE):/ { content = $0; gsub(/^\\+[[:space:]]*/, "", content); gsub(/^[[:space:]]+/, "", content); if (file && line) print file ":" line ":" content; line++ }
                '`,
                { encoding: 'utf-8' }
              ).trim();
            } catch (error) {
              console.log('Error finding TODOs:', error.message);
              todos = '';
            }

            // Find existing comment from this bot
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            console.log(`Found ${comments.data.length} total comments on this PR`);

            // Find bot comment - check for bot type OR GitHub Actions bot login
            const botComment = comments.data.find(comment => {
              const isBot = comment.user.type === 'Bot' ||
                           comment.user.login === 'github-actions[bot]' ||
                           comment.user.login.includes('[bot]');
              const hasTodoHeader = comment.body && comment.body.includes('ðŸ“‹ New or Modified TODOs in This PR');
              return isBot && hasTodoHeader;
            });

            if (botComment) {
              console.log(`Found existing bot comment (ID: ${botComment.id})`);
            } else {
              console.log('No existing bot comment found');
            }

            // Check if todos is empty (no TODOs found)
            if (!todos || todos.length === 0) {
              // No TODOs found - delete existing comment if it exists
              if (botComment) {
                console.log('No TODOs found, deleting existing comment...');
                try {
                  await github.rest.issues.deleteComment({
                    comment_id: botComment.id,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                  });
                  console.log('Comment deleted successfully');
                } catch (error) {
                  console.error('Error deleting comment:', error.message);
                  throw error;
                }
              } else {
                console.log('No TODOs found and no existing comment to delete');
              }
              return;
            }

            const body = '## ðŸ“‹ New or Modified TODOs in This PR\n\n' +
              'The following TODO/FIXME/XXX comments were **added or modified** in this PR (pre-existing TODOs are ignored):\n\n' +
              '```\n' +
              todos +
              '\n```\n\n' +
              '**Note:** This is informational. Please ensure TODOs are tracked in issues or removed before merging.';

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
