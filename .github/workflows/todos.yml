name: Check TODOs

on:
  pull_request:
    branches: [main, master, develop]

jobs:
  check-todos:
    name: Check for TODOs
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to compare branches

      - name: Find new/modified TODOs in PR
        id: find-todos
        run: |
          echo "ðŸ“‹ Checking for new or modified TODOs, FIXMEs, and XXX comments in PR..."
          echo ""

          # Get base branch (default to main)
          BASE_BRANCH="${GITHUB_BASE_REF:-main}"

          # Fetch base branch for comparison
          git fetch origin "$BASE_BRANCH:$BASE_BRANCH" || true

          # Find TODOs only in added/modified lines (not pre-existing)
          # Use git diff to find lines that were added or changed
          TODOS=$(git diff "$BASE_BRANCH...HEAD" --unified=0 | \
            grep -E '^\+.*(TODO|FIXME|XXX|HACK|NOTE):' | \
            grep -v '^+++' | \
            sed 's/^+//' || true)

          if [ -z "$TODOS" ]; then
            echo "âœ… No new or modified TODOs found in PR!"
            echo "has_todos=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Found new or modified TODOs/FIXMEs/XXX comments:"
            echo ""
            echo "$TODOS"
            echo ""
            echo "has_todos=true" >> $GITHUB_OUTPUT

            # Count by type
            TODO_COUNT=$(echo "$TODOS" | grep -c "TODO:" || echo "0")
            FIXME_COUNT=$(echo "$TODOS" | grep -c "FIXME:" || echo "0")
            XXX_COUNT=$(echo "$TODOS" | grep -c "XXX:" || echo "0")

            echo "ðŸ“Š Summary:"
            echo "  TODO: $TODO_COUNT"
            echo "  FIXME: $FIXME_COUNT"
            echo "  XXX: $XXX_COUNT"
          fi

      - name: Comment on PR (if TODOs found)
        if: github.event_name == 'pull_request' && steps.find-todos.outputs.has_todos == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');

            // Get base branch
            const baseBranch = process.env.GITHUB_BASE_REF || 'main';

            // Find TODOs only in added/modified lines using git diff
            const todos = execSync(
              `git diff ${baseBranch}...HEAD --unified=0 | grep -E '^\\+.*(TODO|FIXME|XXX|HACK|NOTE):' | grep -v '^+++' | sed 's/^+//'`,
              { encoding: 'utf-8' }
            ).trim();

            if (!todos) {
              return;
            }

            const body = '## ðŸ“‹ New or Modified TODOs in This PR\n\n' +
              'The following TODO/FIXME/XXX comments were **added or modified** in this PR (pre-existing TODOs are ignored):\n\n' +
              '```\n' +
              todos +
              '\n```\n\n' +
              '**Note:** This is informational. Please ensure TODOs are tracked in issues or removed before merging.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
